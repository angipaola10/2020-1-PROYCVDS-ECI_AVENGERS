<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core" xmlns:p="http://primefaces.org/ui">
	<h:head>
		<title>Banco de iniciativas ECI</title>
		<link href="assets/css/consultari.css" rel="stylesheet"/>
		<link  rel="icon"   href="assets/img/favicon.png" type="image/png" />
		<!--<script type="text/javascript">
		  function actualizar(){location.reload(true);}
		//Función para actualizar cada 4 segundos(4000 milisegundos)
		  setInterval("actualizar()",4000);
		</script>-->
		<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	    <script type="text/javascript">
	      google.charts.load('current', {'packages':['corechart']});
	      google.charts.setOnLoadCallback(drawChart);
	      function drawChart() {

	    	var tabla = "#{BancoPropuestasBean.agruparIniciativas()}";
			console.log(tabla);
	    	var cadena = tabla.slice(1,-1);
	     	var tabla1 = cadena.split(",")
	    	var tabla2 = []
	    	tabla2.push(["Estado","Numero"]);
	    	var lon=tabla1.length
	    	var cont=0;
	    	for ( i in tabla1){
	    		
	    		console.log(tabla1[cont] + "vvvv "+ tabla1[cont+1]+"mod:"+ i%2 + " vvvv "+ cont +" otro"+ cont+2);
	    		tabla2.push([tabla1[cont],parseInt(tabla1[cont+1])])
	    		cont+=2;
	    		if (cont == lon){ break}
	   	    	}
	        var data = google.visualization.arrayToDataTable(tabla2);
	
	        var options = {
	          title: 'Areas de iniciativas'
	        };
	
	        var chart = new google.visualization.PieChart(document.getElementById('piechart'));
	
	        chart.draw(data, options);
	      }
	    </script>
	    
	    		<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	    <script type="text/javascript">
	      google.charts.load('current', {'packages':['corechart']});
	      google.charts.setOnLoadCallback(drawChart);
	      function drawChart() {
			var tabla = "#{BancoPropuestasBean.consultarEstados()}";
			var cadena = tabla.slice(1,-1);
	     	var tabla1 = cadena.split(",")
	    	var tabla2 = []
	    	tabla2.push(["Estado","Numero"]);
	    	var lon=tabla1.length
	    	var cont=0;
	    	for ( i in tabla1){
	    		tabla2.push([tabla1[cont],parseInt(tabla1[cont+1])])
	    		cont+=2;
	    		if (cont == lon){ break}
	   	    	}
	        var data = google.visualization.arrayToDataTable(tabla2);
	
	        var options = {
	          title: 'Estado de iniciativas'
	        };
			
	        var chart = new google.visualization.PieChart(document.getElementById('piechart2'));
			
	        chart.draw(data, options);
	      }
	    </script>
	    
		
		<script type="text/javascript">
			function alerta() {
				alert("Estado actualizado");
				location.reload(true)
				
			}
			
		</script>
		
	</h:head>
	<body>
		<h:form id="form"> 
			<div class="cabecera">
				<img src= "assets/img/cabecera.jpg"/>
			</div>
			<div class = "header">
				<b>Consultar iniciativas</b>
					<ul class="nav">
						<li><a href="">Iniciativas</a>
							<ul>
								<li><a href="">Consultar iniciativas</a></li>
							</ul>
						</li>
						<li><a>Usuarios</a>
							<ul>
								<li><a href="../faces/consultarUsuarios.xhtml">Consultar usuarios</a></li>
							</ul>
						</li>
						<li>
							<p:commandButton value="Cerrar sesión"
										class="btn btn-rose btn-simple btn-wd btn-lg"
										action="#{shiroBean.doLogOut()}"/>					
						</li>
					</ul>
			</div>
			<p:dataTable var="iniciativa" value="#{BancoPropuestasBean.consultarIniciativas()}" class="tabla"
				paginator="true" paginatorPosition = "bottom" paginatorTemplate="{FirstPageLink} {PreviousPageLink} {CurrentPageReport} {NextPageLink} {LastPageLink}"
				rows="15" selectionMode="single" id="tablaConsulta" selection="#{BancoPropuestasBean.selectedIniciativa}" rowKey="#{iniciativa.nombrePropuesta}">
				
				<f:facet name="header" >
					<p:selectOneMenu id="cons-ini" binding="#{pclaveini}">
						<f:selectItem itemLabel="Seleccione una palabra clave" itemValue="Palabra" noSelectionOption="true" />
						<f:selectItems value="#{BancoPropuestasBean.consultarPalabrasClavesString()}" />
					</p:selectOneMenu>
					<p:commandButton value="Consultar" style="background:#b80f22;color: #fff;text-shadow:none;box-shadow:none;margin-left: 10px;border:none;"  actionListener="#{BancoPropuestasBean.consultarIniciativaPalabraClave(pclaveini.getValue())}" >
					</p:commandButton>
					<p:selectOneMenu id="act-estado" binding="#{estadoi}" style="margin-left:50px;">
						<f:selectItem itemLabel="Seleccione un estado" itemValue="" noSelectionOption="true" />
						<f:selectItems value="#{BancoPropuestasBean.estadosIniciativas}" />
					</p:selectOneMenu>
					<p:commandButton id="mensaje" value="Actualizar estado"
									style="background:#b80f22;color: #fff;text-shadow:none;box-shadow:none;margin-left: 10px;border:none;"
									actionListener="#{BancoPropuestasBean.modificarIniciativaEstado(estadoi.value)}" onclick="alerta()"/>
					</f:facet>
				
				<p:column headerText="Nombre" filterBy="#{iniciativa.nombrePropuesta}" sortBy="#{iniciativa.nombrePropuesta}">
					<h:outputText value="#{iniciativa.nombrePropuesta}"/>
				</p:column>
				
				<p:column headerText="Nombre proponente" filterBy="#{iniciativa.nombreProponente}" sortBy="#{iniciativa.nombreProponente}">
					<h:outputText value="#{iniciativa.nombreProponente}"  />
				</p:column>
				
				<p:column headerText="Usuario proponente" filterBy="#{iniciativa.usuario}" sortBy="#{iniciativa.usuario}">
					<h:outputText value="#{iniciativa.usuario}" />
				</p:column>
			 
				<p:column headerText="Descripcion" filterBy="#{iniciativa.descripcion}" sortBy="#{iniciativa.descripcion}">
					<h:outputText value="#{iniciativa.descripcion}" />
				</p:column>
			 
				<p:column headerText="Area" filterBy="#{iniciativa.area}" sortBy="#{iniciativa.area}">
					<h:outputText value="#{iniciativa.area}" />
				</p:column>

				<p:column headerText="Estado" filterBy="#{iniciativa.estado_Propuesta}" sortBy="#{iniciativa.estado_Propuesta}">
					<h:outputText value="#{iniciativa.estado_Propuesta}" />
				</p:column>
				
				<p:column headerText="Likes" sortBy="#{BancoPropuestasBean.consultarLikes(iniciativa.id)}"
							style="width:60px;text-align: center">
					<p:commandButton id="like" value="" class="like" style="background:transparent;text-shadow:none;box-shadow:none;margin-left: 10px;border:none;"/>
					<style type="text/css">
						.like {
							width:25px;
							height:25px;
							background-image: url("assets/img/liken.png") !important;
						}
						.like:hover{
							background-image: url("assets/img/likeh.png") !important;
						}
					</style>
					<p:commandButton value="#{BancoPropuestasBean.consultarLikes(iniciativa.id)}" style="background:transparent;text-shadow:none;box-shadow:none;margin-left: 10px;border:none;"/>
				</p:column>
				
				<p:column style="width:30px;text-align: center">
					 <p:commandButton  update=":form:iniDetail" oncomplete="PF('iniDialog').show()" title="Ver"
						style="background:#b80f22;color: #fff;text-shadow:none;box-shadow:none;;border:none;">
						<f:setPropertyActionListener value="#{iniciativa}" target="#{BancoPropuestasBean.selectedIniciativa}"/>
					</p:commandButton>
				</p:column>
				
			</p:dataTable>   
			
			<p:dialog header="Iniciativa Info" widgetVar="iniDialog" modal="true" showEffect="fade" hideEffect="fade" resizable="false">
				<p:outputPanel id="iniDetail" style="width:430px;">
					<p:panelGrid  columns="2" rendered="#{not empty BancoPropuestasBean.selectedIniciativa}" columnClasses="label,value"
								layout="grid" >
						
						<h:outputText value="Iniciativa No."/>
						<p:inputTextarea rows="1" cols="20" value="#{BancoPropuestasBean.selectedIniciativa.id}" readonly="true"
											style="box-shadow:none;background:#E5E5E5;border:none;"/>
					
						<h:outputText value="Nombre iniciativa" />
						<p:inputTextarea rows="1" cols="20" value="#{BancoPropuestasBean.selectedIniciativa.nombrePropuesta}" readonly="false"
											style="box-shadow:none;background:#E5E5E5;border:none;"/>
						
						<h:outputText value="Descripcion" />
						<p:inputTextarea cols="20" value="#{BancoPropuestasBean.selectedIniciativa.descripcion}" readonly="true"
										style="box-shadow:none;background:#E5E5E5;border:none;"/>
						
						<h:outputText value="Area" />
						<p:inputTextarea rows="1" cols="20" value="#{BancoPropuestasBean.selectedIniciativa.area}" readonly="false"
											style="box-shadow:none;background:#E5E5E5;border:none;"/>
						
						<h:outputText value="Nombre proponente" />
						<p:inputTextarea rows="1" cols="20" value="#{BancoPropuestasBean.selectedIniciativa.nombreProponente}" readonly="true"
										style="box-shadow:none;background:#E5E5E5;border:none;"/>
						
						<h:outputText value="Usuario proponente" />
						<p:inputTextarea rows="1" cols="20" value="#{BancoPropuestasBean.selectedIniciativa.usuario}" readonly="true"
										style="box-shadow:none;background:#E5E5E5;border:none;"/>
						
						<h:outputText value="Estado" />
						<p:inputTextarea rows="1" cols="20" value="#{BancoPropuestasBean.selectedIniciativa.estado_Propuesta}" readonly="true"
										style="box-shadow:none;background:#E5E5E5;border:none;"/>
						
					</p:panelGrid>
					<p:dataTable var="pclaveinic" value="#{BancoPropuestasBean.consultarPalabrasClaveIniciativa()}" class="tabla" style="width:300px;">
						<p:column headerText="Palabras clave">
							<h:outputText value="#{pclaveinic.palabraClave}" />
						</p:column>
					</p:dataTable>
				</p:outputPanel>
				
			</p:dialog>

        </h:form>  
        
        <div id="piechart" style="width: 900px; height: 500px;"></div>
        <div id="piechart2" style="width: 900px; height: 500px;"></div>
        <p class="copyright text-muted">Daniela Ruiz - Angie Jimenez  - Henry Sanchez - Edwin Rodriguez</p>
	</body>
</html>
